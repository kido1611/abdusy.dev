---

title: 'Hardening SSH Server'
description: 'Mengkonfigurasi SSH Server menjadi aman dan tentram'
author: 'Muhammad Abdusy Syukur'
created_at: '2024-07-29 08:40:50'

---

# Hardening SSH Server

## Update Software

Sebelum melakukan konfigurasi, lakukan upgrade sistem terlebih dahulu.

```sh
sudo apt update -y && sudo apt upgrade -y && sudo apt autoremove -y
```

## Install OpenSSH Server

```sh
sudo apt install openssh-server -y
```

## Persiapan

### Buat user khusus

TODO

### Generate SSH Key - Client

Salah satu cara hardening adalah tidak menggunakan password untuk login ke
server, tetapi menggunakan ssh key. SSH key bisa dicek melalui `ls ~/.ssh`.
Nanti akan muncul 2 file seperti `id_ed25519` dan `id_ed25519.pub` atau
`id_rsa4096` dan `id_rsa4096.pub`.

Untuk membuat SSH key bisa dengan cara:
```sh
ssh-keygen -t ed25519 -C "your@email.com"
```

Sumber referensi: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent

### Install SSH Key - Server

Terdapat 2 cara untuk menginstall SSH key ke server.

#### Cara manual

1. Baca dan copy ssh key yang berextensi `.pub`

```sh
cat ~/.ssh/id_ed25519.pub
```

2. Login ke server dan edit file `~/.ssh/authorized_keys`, dan paste SSH
publik key ke file tersebut.

```sh
vim ~/.ssh/authorized_keys
```

#### Cara mudah

```sh
ssh-copy-id -i ~/.ssh/id_ed25519 -p 22 ahmad@ip-server
```

Sumber referensi: https://www.ssh.com/academy/ssh/copy-id

#### Copy SSH key dari GitHub

```sh
curl https://github.com/kido1611.keys | tee -a ~/.ssh/authorized_key
```

> Dengan menginstall SSH key, ketika login ke server tidak akan ditanya password lagi.

## Konfigurasi SSH Server

Untuk melakukan konfigurasi SSH, dapat dilakukan dengan mengubah file
`/etc/ssh/sshd_config`. Hanya saja, cara ini tidak direkomendasikan karena
file tersebut bisa saja berubah ketika package OpenSSH diperbarui
(akan ada konfirmasi, pengalaman sewaktu menggunakan ubuntu server).

Oleh karena itu, konfigurasi lebih baik ditaruh di directory
`/etc/ssh/sshd_config.d/`. Pada kasus ini, akan dibuat file konfigurasi dengan
nama `100-custom-ssh.conf`.

### Cek konfigurasi

Konfigurasi OpenSSH dapat dicek menggunakan perintah:

```sh
sudo sshd -T
```

### Ganti Port

Ganti port dapat dilakukan dengan mengganti variable `Port {nomor port}`.

```conf
Port 222
```

> Pastikan hanya 1 port saja yang aktif. SSH Server bisa
> menggunakan banyak port. Pengecekan Dapat dilakukan
> dengan cara menggunakan perintah: `sudo sshd -T | grep port`.

### Matikan autentikasi untuk user root

```conf
PermitRootLogin no
```

### Matikan autentikasi tanpa password

```conf
PermitEmptyPasswords no
```

### Kurangi durasi autentikasi

Hal ini berpengaruh untuk mengatasi brute-force attack.

```conf
LoginGraceTime 0
```

> Semakin kecil semakin bagus

User login --> Server
Server Ok --> Notify user
User isi password --> Server
`LoginGraceTime` membatasi waktu ketika user mengisi password

### Kurangi jumlah percobaan ketika gagal

```conf
MaxAuthTries 2
```

> Semakin kecil semakin bagus

### Ijinkan autentikasi menggunakan public key

```conf
PubkeyAuthentication yes
```

### Matikan autentikasi menggunakan password

```conf
PasswordAuthentication no
```

### Kurangi durasi ketika user idle

```conf
ClientAliveInterval 300
```

### Kurangi jumlah ping / cek kondisi user

Setelah user idle selama `ClientAliiveInterval`, SSH server akan melakukan
ping / cek kondisi ke user sebelum koneksi terputus. `ClientAliveCountMax`
berfungsi untuk melakukan berapa kali percobaan sebelum koneksi terputus.

```conf
ClientAliveCountMax 1
```

### Matikan X11 Forwarding

Matikan X11 forwarding jika tidak digunakan.

```conf
X11Forwarding no
```

### Hanya aktifkan SSH untuk user tertentu saja

```conf
AllowUsers abdusy
```

### Keseluruhan Konfigurasi

```conf
Port 222
PermitRootLogin no
PermitEmptyPasswords no
LoginGraceTime 0
MaxAuthTries 2
PubkeyAuthentication yes
PasswordAuthentication no
ClientAliveInterval 300
ClientAliveCountMax 1
X11Forwarding no
AllowUsers abdusy
```

## Fail2Ban

### Install Fail2Ban

```sh
sudo apt install -y fail2ban
```

### Copy jail

```sh
cd /etc/fail2ban
sudo cp jail.conf jail.local
```

### Ubah Konfigurasi

Untuk mengubah konfigurasi, lakukan edit pada file `jail.local`

```ini
# durasi blokir
bantime = 360m

# aktifkan penambahan durasi blokir
bantime.increment = true

# faktor pengali durasi blokir
bantime.factor = 2

# maksimal durasi blokir
bantime.maxtime = 86400  # Maximum ban time of 1 day

# durasi maksimal untuk user ketika gagal login sebelum diblokir
findtime = 360m

# banyaknya percobaan ketika gagal sebelum diblokir
maxretry = 2

[sshd]
enabled = true
port = 222 # Disesuaikan dengan port ssh yang digunakan
```

### Enable dan Start Service

```sh
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### Unban IP Address

```sh
sudo fail2ban-client set sshd unbanip <ip-address>
```

## Configure Ubuntu Firewall (UFW)

### Install UFW

```sh
sudo apt install -y ufw
```

### Larang Masuk, Ijinkan Keluar

```sh
sudo ufw default deny incoming
sudo ufw default allow outgoing
```

### Ijinkan / Blokir / Hapus

Yang wajib dilakukan adalah mengijinkan port ssh

```sh
sudo ufw allow 222
```

Untuk memblokir, gunakan

```sh
sudo ufw deny <port>
```

Contoh kompleks:

```sh
# berdasarka IP Address
sudo ufw allow from 203.0.113.4 to any port 22

# berdasarkan IP range
sudo ufw allow from 203.0.113.0/24 to any port 22

# berdasarkan network interface
sudo ufw allow in on eth0 to any port 80

# blokir berdasarkan ip
sudo ufw deny from 203.0.113.4

# blokir port 25 untuk keluar
sudo ufw deny out 25
```

Untuk menghapus, tampilkan terlebih dahulu semua rule

```sh
sudo ufw status numbered

sudo ufw delete <index>
```

### Blokir Ping Server

Untuk memblokir ping, ubah file `/etc/ufw/before.rules`

```conf
# ok icmp codes for INPUT
-A ufw-before-input -p icmp --icmp-type destination-unreachable -j ACCEPT
-A ufw-before-input -p icmp --icmp-type time-exceeded -j ACCEPT
-A ufw-before-input -p icmp --icmp-type parameter-problem -j ACCEPT
-A ufw-before-input -p icmp --icmp-type echo-request -j ACCEPT

# ok icmp code for FORWARD
-A ufw-before-forward -p icmp --icmp-type destination-unreachable -j ACCEPT
-A ufw-before-forward -p icmp --icmp-type time-exceeded -j ACCEPT
-A ufw-before-forward -p icmp --icmp-type parameter-problem -j ACCEPT
-A ufw-before-forward -p icmp --icmp-type echo-request -j ACCEPT
```

Comment kode diatas menjadi

```conf
# ok icmp codes for INPUT
# -A ufw-before-input -p icmp --icmp-type destination-unreachable -j ACCEPT
# -A ufw-before-input -p icmp --icmp-type time-exceeded -j ACCEPT
# -A ufw-before-input -p icmp --icmp-type parameter-problem -j ACCEPT
# -A ufw-before-input -p icmp --icmp-type echo-request -j ACCEPT

# ok icmp code for FORWARD
# -A ufw-before-forward -p icmp --icmp-type destination-unreachable -j ACCEPT
# -A ufw-before-forward -p icmp --icmp-type time-exceeded -j ACCEPT
# -A ufw-before-forward -p icmp --icmp-type parameter-problem -j ACCEPT
# -A ufw-before-forward -p icmp --icmp-type echo-request -j ACCEPT
```

Restart rules:

```sh
sudo ufw reload
```

### Aktifkan UFW

```sh
sudo ufw enable
```

Untuk mematikan, gunakan:

```sh
sudo ufw disable
```

## Enable SSH with 2FA

### Install PAM Google Authenticator

```sh
sudo apt install libpam-google-authenticator
```

### Generate Kode 2FA

```sh
google-authenticator
```

```
Do you want authentication tokens to be time-based (y/n) y

Code confirmed
Your emergency scratch codes are:
  55823515
  41117677
  18526707
  75184027
  75750429

Do you want me to update your "/home/.../.google_authenticator" file? (y/n) y

Do you want to disallow multiple uses of the same authentication
token? This restricts you to one login about every 30s, but it increases
your chances to notice or even prevent man-in-the-middle attacks (y/n) y

By default, a new token is generated every 30 seconds by the mobile app.
In order to compensate for possible time-skew between the client and the server,
we allow an extra token before and after the current time. This allows for a
time skew of up to 30 seconds between authentication server and client. If you
experience problems with poor time synchronization, you can increase the window
from its default size of 3 permitted codes (one previous code, the current
code, the next code) to 17 permitted codes (the 8 previous codes, the current
code, and the 8 next codes). This will permit for a time skew of up to 4 minutes
between client and server.
Do you want to do so? (y/n) n

If the computer that you are logging into isn't hardened against brute-force
login attempts, you can enable rate-limiting for the authentication module.
By default, this limits attackers to no more than 3 login attempts every 30s.
Do you want to enable rate-limiting? (y/n) y
```

Sumber Referensi: https://www.linode.com/docs/guides/secure-ssh-access-with-2fa/

### Aktifkan Google Authenticator PAM

```sh
sudo vim /etc/pam.d/sshd
```

Matikan password autentikasi dengan mendisable `common-auth`
```conf
# @include common-auth
```

Sumber referensi: https://docs.vultr.com/how-to-use-two-factor-authentication-with-sudo-and-ssh-on-linux-with-google-authenticator

Aktifkan 2FA

```conf
auth    required        pam_google_authenticator.so
```

Aktifkan autentikasi menggunakan keyboard di SSH.

```sh
sudo vim /etc/ssh/sshd_config.d/101-2fa.conf
```

```conf
# Aktifkan autentikasi menggunakan keyboard. Dibutuhkan untuk mengisi kode 2FA
KbdInteractiveAuthentication yes

# Aktifkan metode autentikasi hanya menggunakan publickey dan keyboard-interactive
AuthenticationMethods publickey,keyboard-interactive
```

## Login Notification

### Buat Script Untuk Mengirim Notifikasi

`/usr/bin/ssh-login-notify.sh`

```sh
#!/usr/bin/env bash

BOT_TOKEN="bot token"

CHAT_ID="chat id"
MESSAGE_THREAD_ID="thread id"

# prepare any message you want
SERVER_HOSTNAME="$(hostname)"
LOGIN_IP="$(echo $SSH_CONNECTION | cut -d " " -f 1)"
LOGIN_DATE="$(TZ=Asia/Jakarta date "+%A"), $(TZ=Asia/Jakarta date --iso-8601=second)"
LOGIN_USERNAME="$PAM_USER"

if [[ ${PAM_TYPE} = "open_session" ]]; then
curl --location -m 1 --request POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
--header 'Content-Type: application/json' \
--data "{
  \"chat_id\": \"$CHAT_ID\",
  \"message_thread_id\": \"$MESSAGE_THREAD_ID\",
  \"parse_mode\": \"markdown\",
  \"text\": \"*Server Login Notification*\n\r----\n\rServer: *#$SERVER_HOSTNAME*\n\rTanggal: *$LOGIN_DATE*\n\rUsername: *$LOGIN_USERNAME*\n\rIP Address: *$LOGIN_IP*\"
}"
fi
```

### Aktifkan Pengirim Notifikasi

Tambahkan eksekutor, `/etc/pam.d/ssh`

```conf
session optional        pam_exec.so     /usr/bin/ssh-login-notify.sh
```

---
title: "Drizzle ORM + Turso + Nuxt"
description: "Mengkombinasikan Drizzle ORM + Turso SQLite dengan Nuxt"
author: "Muhammad Abdusy Syukur"
created_at: "2024-02-18 13:18:00"
---

`Drizzle ORM` merupakan library `ORM` opensource baru. Drizzle bekerja dengan relational DB seperti `PostgreSQL`, `MySQL`, dan `SQLite`. Drizzle ORM hadir sebagai saingan dari `Prisma`.

Untuk mempemudah dalam mempelajarinya, akan dibuat sebuah `API logger`, akan menyimpan data IP Address dan `url path` setiap endpoint diakses pada Nuxt.

| logs       | data type |
| ---------- | --------- |
| id         | int       |
| ip_address | string    |
| path       | string    |
| created_at | string    |

## Installation

Untuk menggunakan Drizzle ORM dan Turso, dibutuhkan 2 (3 untuk studio) library.

```shell
pnpm add drizzle-orm @libsql/client
pnpm add -D drizzle-kit
```

### Run Script

tambahkan script untuk meng-generate, push data migration, ataupun untuk membuka drizzle studio.

```json
{
  "scripts": {
    "drizzle-generate": "drizzle-kit generate:sqlite",
    "drizzle-push": "drizzle-kit push:sqlite",
    "drizzle-studio": "drizzle-kit studio"
  }
}
```

## Config

### .env

Buat .env file untuk menyimpan Turso URL dan auth-token.

```env .env
NUXT_TURSO_URL=libsql://{....}.turso.io
NUXT_TURSO_AUTH_TOKEN={turso token}
```

Kode diatas sengaja dibuat menggunakan NUXT\_... supaya bisa diakses oleh Nuxt Runtime Config secara override.

### Runtime Config

Tambhakan runtime config untuk mengambil data auth turso

```ts nuxt.config.ts
export default defineNuxtConfig({
  ...,
  runtimeConfig: {
    tursoUrl: "",
    tursoAuthToken: "",
  },
  ,,,
});

```

### Drizzle Config

Buat file drizzle.config.ts

```ts
import "dotenv/config";
import type { Config } from "drizzle-kit";
export default {
  schema: "./db/schema.ts",
  out: "./drizzle",
  driver: "turso",
  dbCredentials: {
    url: process.env.NUXT_TURSO_URL ?? "",
    authToken: process.env.NUXT_TURSO_AUTH_TOKEN ?? "",
  },
} satisfies Config;
```

## Schema & Migration

### Schema

Buat file schema.ts di folder db

```ts /db/schema.ts
import { sql } from "drizzle-orm";
import {
  sqliteTable,
  text,
  integer,
  uniqueIndex,
} from "drizzle-orm/sqlite-core";

export const logs = sqliteTable("logs", {
  id: integer("id").primaryKey(),
  ipAddress: text("ip_address").notNull(),
  path: text("path").notNull(),
  createdAt: text("created_at")
    .notNull()
    .default(sql`CURRENT_TIMESTAMP`),
});
```

### Generate Migration

```shell
pnpm drizzle-generate
```

### Run migration

```shell
pnpm drizzle-push
```

## Connection Script

```ts /utils/db.ts
import { H3Event } from "h3";
import { drizzle } from "drizzle-orm/libsql";

import { createClient } from "@libsql/client";

export default (event?: H3Event) => {
  const runtimeConfig = useRuntimeConfig(event);

  const connection = createClient({
    url: runtimeConfig.tursoUrl,
    authToken: runtimeConfig.tursoAuthToken,
  });

  return drizzle(connection);
};
```

## Insert (Server Middleware)

Untuk melakukan insert, akan digunakan server middleware, supaya bisa otomatis melakukan insert ketika API digunakan.

```ts /server/middleware/01.logger.ts
import db from "~/utils/db";
import { logs } from "~/db/schema";

export default defineEventHandler(async (event) => {
  const ip = getRequestIP(event);

  // jika berjalan dibelakang reverse proxy / load balancer, tambahkan xForwardedFor
  // const ip = getRequestIP(event, { xForwardedFor: true })

  await db(event)
    .insert(logs)
    .values({
      ipAddress: ip || "",
      path: event.path,
    });
});
```

## View (Api)

Untuk view (select query), akan menggunakan [api/logs](/api/logs){:target="\_blank"} sebagai endpoint.

```ts /server/api/logs/index.get.ts
import { desc } from "drizzle-orm";

import db from "~/utils/db";
import { logs } from "~/db/schema";

export default defineEventHandler(async (event) => {
  const selectLogs = await db(event)
    .select()
    .from(logs)
    .orderBy(desc(logs.createdAt))
    .limit(50);

  return {
    logs: selectLogs,
  };
});
```
